# BGD
Bayesian Gaussian decomposition algorithm

Written by Anita Petzler
Last modified 23 July 2018

Bayesian Gaussian Decomposer (BGD) uses a Bayesian approach to model evaluation to fit Gaussian curves 
to sets of spectra of the four 2 PI 3/2 J = 3/2 ground state transitions of OH. The current version does not 
allow for incomplete input spectra, so they must have the same velocity ranges. If only one satellite line 
is observed you can duplicate it for the other satellite line as the current version doesn't include a 
radiative transfer model. This will hopefully change.

The identification of initial positions for the Gaussians (BGD.IdentifyGaussians) uses a regularised 
differentiation algorithm borrowed from gausspy (https://github.com/gausspy/gausspy, see Lindner et al. 2015 
AJ 149 138). This includes the class 'GaussianDecomposer' and functions 'initialGuess', 'TVdiff', 'AGD', 
'init_worker', 'init', 'decompose_one' and 'func'. The documentation that accompanies BGD therefore doesn't 
describe these functions.

The code that eventually became BGD was begun as part of my Master's of Research degree at Macquarie University 
but is unpublished in its much more complete current form. If used, please cite my Master's thesis for now: 
  
  Petzler, A. (2018). Probing the Galactic ISM in OH Absorption (Master's thesis). Macquarie University, 
  Australia.


General advice:

See 'BGD_sample.py' for a sample implementation of BGD.

If you get the error 'OSError: [Errno 24] Too many open files', reset the number of 
allowed open files in the command line via:

$ ulimit -a

...

max memory size         (kbytes, -m) unlimited

open files                      (-n) 256			<-----

pipe size            (512 bytes, -p) 1

...

$ ulimit -Sn 10000

$ ulimit -a

...

max memory size         (kbytes, -m) unlimited

open files                      (-n) 10000			<-----

pipe size            (512 bytes, -p) 1

...




API:

BGD.IdentifyGaussians(data, fwhm, dv):

	Uses an autonomous Gaussian decomposition from Bob Lindner's Gausspy to identify potential features.
	Returns a list of grouped velocities.
	Parameters:
	data - dictionary object generated by Main()
	fwhm - estimate of the minimum full width at half-maximum of features expected in the data in km/sec.
			Used when categorising features as isolated or blended.
	dv - velocity resolution determined by Main() from average of main line (1665, 1667) resolutions.
			Used when merging features identified across the four OH transitions.

	Returns nested list of velocities identified by AGD algorithm:
		reduced_vel_list = [[v1], [v2, v3], [v4]]
		
		where v1 and v4 are isolated features that can be fit independently, but v2 and v3 are close 
		enough in velocity that they must be fit together as a blended feature.

BGD.BatchAGD(source_name, freq, vel_axis, spectrum, rms):

	Perform autonomous Gaussian decomposition (AGD) on given sightline and frequency for the alpha values 
	defined by min_alpha, max_alpha, alpha_step. If the program finds too many 'features' that are actually 
	noise, remove the lower alpha values. If it finds too many wide features, remove the higher alpha numbers.
	Will save velocity lists as pickles then merge the lists from the range of alpha values. 
	Parameters:
	source_name - unique identifier for sightline to be used when saving pickles during Gaussian decomposition 
			process.
	freq - string used to identify the OH transition ('1612', '1665', '1667' or '1720')
	vel_axis - velocity axis
	spectrum - transition spectrum (i.e. brightness temperature, optical depth)
	rms - root mean square error of spectrum. Used by autonomous Gaussian decomposition algorithm

	Returns a list of initial guesses of centroid velocity for a range of alpha values. Here alpha is a proxy 
	for feature width. 

BGD.RunAGD(source_name, freq, alpha, vel_axis, spectrum, rms):
	'''
	Uses regularised differentiation algorithm borrowed from Bob Lindner's Gausspy, identifying minima in the 
	2nd derivative as potential locations of Gaussian emission features. It also performs this process on 
	-1 * spectrum to identify absorption features. Returns a list of these velocities.
	Parameters:
	source_name - unique identifier for sightline to be used when saving pickles during Gaussian decomposition 
			process.
	freq - string used to identify the OH transition ('1612', '1665', '1667' or '1720')
	alpha - log(alpha) parameter use in regularised differentiation (see Tikhonov 1963 'Reviews of Topical 
			Problems: Peaks of Random Processes' Soviet Physics Uspekhi 5, 594, and Lindner et al. 2015 AJ 
			149, 138.)
	vel_axis - velocity axis
	spectrum - transition spectrum (i.e. brightness temperature, optical depth)
	rms - root mean square error of spectrum. Used by autonomous Gaussian decomposition algorithm

	Returns a list of initial guesses of centroid velocity for a range of alpha values. Here alpha is a proxy 
	for feature width. 
	'''
BGD.AddDataDecomp(data_decomp_pos, data_decomp_neg):
	'''
	Concatenates positive decomposition with corrected negative decomposition from RunAGD()

	Returns a list of initial guesses of centroid velocities.
	'''
BGD.ReduceList(master_list, merge_size, group_spacing):	
	'''
	Merges values in master_list separated by less than merge_size, and groups features separated by 
	less than group_spacing into blended features.
	Returns a list of lists: i.e. [[a], [b, c, d], [e]] where 'a' and 'e' are isolated
	features and 'b', 'c' and 'd' are close enough to overlap in velocity.

	Parameters:
	master_list - list of velocities
	merge_size - any velocities separated by less than this distance will be merged into one velocity. This 
			is performed in 4 stages, first using merge_size / 4 so that the closest velocities are merged 
			first. Merged velocities are replaced by their mean. Based on extensive testing with synthetic 
			spectra his has been set as 3 * the velocity resolution. If your data have been converted to 
			velocity spectra using imprecise rest frequencies you may wish to increase the value of 
			merge_size.
	group_spacing - any velocities separated by less than this value will be grouped together so they can 
			be fit as blended features. Based on extensive testing with synthetic spectra his has been set 
			as 10 * expected minimum fwhm. Smaller values are likely to prevent the accurate identification 
			of blended features, while larger values will increase running time.

	Returns nested list of velocities:
		reduced_vel_list = [[v1], [v2, v3], [v4]]
		
		where v1 and v4 are isolated features that can be fit independently, but v2 and v3 are close 
		enough in velocity that they must be fit together as a blended feature.
	'''
BGD.MergeFeatures(master_list, size, action):
	'''
	Does the work for ReduceList

	Parameters:
	master_list - list of velocities generated by AGD()
	size - Distance in km/sec for the given action
	action - Action to perform: 'merge' or 'group'
	'''	
BGD.BICnull(data):
	'''
	Finds Bayesian Information Criterion (approximation of the Bayes factor) of the null model (i.e. where 
	tau = 0 at all velocities). See R. E. Kass and A. E. Raftery 1995. 'Bayes factors' Journal of the 
	American Statistical Association 90, 773.

	Parameters:
	data - dictionary object generated by Main()

	Returns Bayesian Information Criterion (float) 
	'''
BGD.MCMC(data, velocity, prev_BIC, fwhm, plot_num, save_as_name):
	'''
	Uses emcee (Markov Chain Monte Carlo algorithm) to simultaneously fit gaussians of a given centroid 
	velocity and fwhm to all four OH transitions. All models have 6n components where n is the number of 
	Gaussians: centroid velocity, fwhm, heights in the four OH transitions.

	NOTE: later versions of BGD will remove the use of MCMC as it's too computationally expensive and not 
	really necessary. It will likely be replaced by mpfit or similar.

	Parameters:
	data - dictionary object generated by Main()
	velocity - list of velocities at which to place a Gaussian
	prev_BIC - BIC of the previous model tested. Used to determine when to stop placing Gaussians
	fwhm - estimate of the minimum full width at half-maximum of features expected in the data in km/sec.
			Used to limit parameter space to 'reasonable' values.
	plot_num - number to uniquely identify generated plots
	save_as_name - name to uniquely identify sightlines in generated plots

	Returns:
	BIC_model - BIC of the identified model
	median_parameters - parameters determined by median of Markov chains
	Convergence_test - 'Pass' or 'Fail': Whether or not the inner 50% of values for centroid velocity and 
			fwhm in the final 50 iterations fall within a given test range.
	Skewness_test - 'Pass' or 'Fail': Whether or not the inner 80% of values for centroid velocity and 
			fwhm in the final 50 iterations have a skewness factor below a given threshold.
	'''
BGD.lnprob(x, velocity, vel_tolerance, data):
	'''
	Note: this is not a true log probability as defined by Bayes' Theorem. 

	Parameters:
	x - Parameters of Gaussian component(s): [vel_1, fwhm_1, height_1612_1, height_1665_1, height_1667_1, 
			height_1720_1, ..., _N] for N components
	velocity - initial values of centroid velocit(ies)
	vel_tolerance - distance Gaussian centroid velocities are allowed to move from their initial values. This 
			aids in the identification of blended features.
	data - dictionary object generated by Main()

	Returns -BIC as a proxy for the log probability
	'''
BGD.lnprior(x, velocity, vel_tolerance, data):
	'''
	Note: this is not a true log prior as defined by Bayes' Theorem.
	limits parameters to 'reasonable' values

	Parameters:
	x - Parameters of Gaussian component(s): [vel_1, fwhm_1, height_1612_1, height_1665_1, height_1667_1, 
			height_1720_1, ..., _N] for N components
	velocity - initial values of centroid velocit(ies)
	vel_tolerance - distance Gaussian centroid velocities are allowed to move from their initial values. This 
			aids in the identification of blended features.
	data - dictionary object generated by Main()

	Returns 0 or -np.inf as a proxy for log prior
	'''
BGD.BIC(x, data):
	'''
	Calculates the new BIC resulting from the model represented by the parameters x

	Parameters:
	x - Parameters of Gaussian component(s): [vel_1, fwhm_1, height_1612_1, height_1665_1, height_1667_1, 
			height_1720_1, ..., _N] for N components
	data - dictionary object generated by Main()	

	Returns BIC (float)
	'''
BGD.MakeModel(x, vel_1612, vel_1665, vel_1667, vel_1720):
	'''
	Constructs a Gaussian model based on parameters given in x.

	Parameters:
	x - Parameters of Gaussian component(s): [vel_1, fwhm_1, height_1612_1, height_1665_1, height_1667_1, 
			height_1720_1, ..., _N] for N components
	vel_XXXX - velocity axes of the 4 OH transitions

	Returns Gaussian models for each of the 4 OH transitions
	'''
BGD.Gaussian(mean, fwhm, height):
	return lambda x: height * np.exp(-4. * np.log(2) * (x - mean)**2 / fwhm**2)
BGD.SkewnessTest(sampler_chain, num_Gauss, test_comp, test_limit):
	'''
	Tests the skewness of the inner 80% of the last 50 iterations of the given spectrum. 

	Parameters:
	sampler_chain - Markov chains from MCMC()
	num_Gauss - number of Gaussian components in the model
	test_comp - Model component to test: 0 for velocity, 1 for fwhm
	test_limit - Threshold used to determine whether or not the test is passed: 2

	Returns 'Pass' or 'Fail'
	'''
BGD.ConvergenceTest(sampler_chain, num_Gauss, test_comp, test_limit):
	'''
	Tests the range of the inner 50% of the last 50 iterations of the given spectrum.

	Parameters:
	sampler_chain - Markov chains from MCMC()
	num_Gauss - number of Gaussian components in the model
	test_comp - Model component to test: 0 for velocity, 1 for fwhm
	test_limit - Threshold used to determine whether or not the test is passed: 2.5 km/sec (based on 
			extensive testing of synthetic spectra with velocity resolution ~0.3 km/sec and fwhm ~ 1-4 km/sec)

	Returns 'Pass' or 'Fail'
	'''
BGD.Main(source_name, vel_axes, spectra, rms, expected_min_fwhm, save_as_name):
	'''
	Performs Bayesian Gaussian Decomposition on velocity spectra of the 2 Pi 3/2 J = 3/2 ground state 
	transitions of OH.

	Parameters:
	source_name - unique identifier for sightline, used in plots, dictionaries etc.
	vel_axes - list of velocity axes: [vel_axis_1612, vel_axis_1665, vel_axis_1667, vel_axis_1720]
	spectra - list of spectra (brightness temperature or tau): [spectrum_1612, spectrum_1665, spectrum_1667, 
			spectrum_1720]
	rms - list of estimates of rms error in spectra: [rms_1612, rms_1665, rms_1667, rms_1720]. Used by AGD
	expected_min_fwhm - estimate of the minimum full width at half-maximum of features expected in the data 
			in km/sec. Used when categorising features as isolated or blended.
	save_as_name - unique identifier for sightline, used when saving plots, reporting results etc. (i.e. can 
		be longer and uglier than source_name)

	Returns parameters of Gaussian component(s): [vel_1, fwhm_1, height_1612_1, height_1665_1, height_1667_1, 
			height_1720_1, ..., _N] for N components
	'''
BGD.ResultsReport(final_parameters, save_as_name):
	'''
	Generates a nice report of results, prints to terminal.
	'''

